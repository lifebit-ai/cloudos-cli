name: CI_tests

on:
  pull_request:
    types: [review_requested, ready_for_review]
    branches:
      - main
      - dev
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  Pytest:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.11"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e '.[test]'
    - name: Run tests
      run: |
        pytest
  job_list:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos job list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID
  job_list_filtering:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Test job list filtering
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        # Test filtering by status, project  and workflow name
        cloudos job list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --filter-status completed --filter-project cloudos-cli-tests  --filter-workflow GH-rnatoy --last --last-n-jobs 10
        # Test filtering job id
        cloudos job list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --filter-job-id 68af3e26628f9dd83dae1c05 
        # Test filtering job name
        cloudos job list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --filter-job-name "cloudos-cli-CI-test" --last-n-jobs 10
        # Test filtering by only mine
        cloudos job list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --filter-only-mine --last-n-jobs 10
        # Test filtering by queue
        cloudos job list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --filter-queue "job_queue_nextflow" --last-n-jobs 10
  job_details:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        JOB_ID="68b9aaab76724fd335457ed3"
        cloudos job details --cloudos-url $CLOUDOS_URL --workspace-id $CLOUDOS_WORKSPACE_ID --apikey $CLOUDOS_TOKEN --job-id $JOB_ID
  job_workdir:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        JOB_ID="68e8b0f503db9b2833b5959f"
        cloudos job workdir --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --job-id $JOB_ID
  job_related_analyses:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        JOB_ID="68b9aaab76724fd335457ed3"
        cloudos job related --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --job-id $JOB_ID
  import_gitlab:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.9" ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: setup.py
      - name: Install dependencies
        run: |
          pip install -e .
      - name: Run tests
        env:
          CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
          CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
          CLOUDOS_URL: "https://cloudos.lifebit.ai"
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          cloudos workflow import --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --workflow-name imported_from_gitlab --workflow-url https://gitlab.com/lifebit-ai/spammer-nf --repository-platform gitlab
  import_github:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.9" ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: setup.py
      - name: Install dependencies
        run: |
          pip install -e .
      - name: Run tests
        env:
          CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
          CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
          CLOUDOS_URL: "https://cloudos.lifebit.ai"
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          cloudos workflow import --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --workflow-name imported_from_github --workflow-url https://github.com/lifebit-ai/spammer-nf --repository-platform github
  job_run_and_status:
    runs-on: ubuntu-latest
    outputs:
      job_id: ${{ steps.get-job-id.outputs.job_id }}
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      id: get-job-id
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        WORKFLOW: "GH-rnatoy"
        JOB_CONFIG: "cloudos_cli/examples/rnatoy.config"
        JOB_NAME_BASE: "cloudos-cli-CI-test"
        COMMIT_HASH: ${{ github.event.pull_request.head.sha }}
        PR_NUMBER: ${{ github.event.number }}
        INSTANCE_TYPE: "m4.xlarge"
      run: |
        JOB_NAME="$JOB_NAME_BASE""|GitHubCommit:""${COMMIT_HASH:0:6}""|PR-NUMBER:""$PR_NUMBER"
        cloudos job run --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --project-name "$PROJECT_NAME" --workflow-name "$WORKFLOW" --job-config $JOB_CONFIG --job-name "$JOB_NAME" --wait-completion --resumable --instance-type $INSTANCE_TYPE 2>&1 | tee out.txt
        JOB_ID=$(grep -e "Your assigned job id is:" out.txt | rev | cut -f1 -d " " | rev)
        echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
        cloudos job status --cloudos-url $CLOUDOS_URL --workspace-id $CLOUDOS_WORKSPACE_ID --apikey $CLOUDOS_TOKEN --job-id $JOB_ID
  job_resume:
    needs: job_run_and_status
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Resume completed job
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        INSTANCE_TYPE: "m4.xlarge"
      run: |
        JOB_ID="${{ needs.job_run_and_status.outputs.job_id }}"
        echo "Resuming job $JOB_ID..."
        cloudos job resume --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --project-name "$PROJECT_NAME" --job-id $JOB_ID --instance-type $INSTANCE_TYPE --wait-completion
        echo "Job resumed successfully!"
  logs_results_aws:
    needs: job_run_and_status
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.9" ]
        feature: ["logs", "results"]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: setup.py
      - name: Install dependencies
        run: |
          pip install -e .
      - name: Run tests
        env:
          CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
          CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
          CLOUDOS_URL: "https://cloudos.lifebit.ai"
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          cloudos job ${{ matrix.feature }} --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --job-id ${{ needs.job_run_and_status.outputs.job_id }}
  workflow_list:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos workflow list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID
  project_list:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos project list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID
  queue_list:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos queue list --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID
  dataset_list:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        PROJECT_NAME: "cloudos-cli-tests"
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos datasets ls --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --project-name "$PROJECT_NAME" 
  dataset_move:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        PROJECT_NAME: "cloudos-cli-tests"
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos datasets mv --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name lm-test Data/test_mv/test_file.txt --destination-project-name "$PROJECT_NAME"  Data/mv_test 
        cloudos datasets mv --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/mv_test/test_file.txt --destination-project-name lm-test Data/test_mv
  dataset_rename:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        PROJECT_NAME: "cloudos-cli-tests"
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos datasets rename --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/test_rename new_renamed_folder
        cloudos datasets rename --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/new_renamed_folder test_rename
  bash_job:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      id: run-bash-job
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        WORKFLOW: "plink2"
        JOB_NAME_BASE: "cloudos_cli_CI_test_bash_job"
        COMMIT_HASH: ${{ github.event.pull_request.head.sha }}
        PR_NUMBER: ${{ github.event.number }}
      run: |
        cloudos bash job \
          --instance-type m4.xlarge \
          --memory 2 \
          --parameter -test=value \
          --parameter --gaq=test \
          --job-name "$JOB_NAME_BASE" \
          --command "echo 'test' > new_file.txt" \
          --workspace-id "$CLOUDOS_WORKSPACE_ID" \
          --project-name "$PROJECT_NAME" \
          --workflow-name plink2 \
          --apikey "$CLOUDOS_TOKEN" \
          --cloudos-url "$CLOUDOS_URL" \
          --wait-completion
  bash_job_clone:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      id: run-bash-job
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        JOB_NAME_BASE: "cloudos_cli_CI_test_bash_job_cloned"
        JOB_ID: "68d51f6b5eb22f6f2f445539"
        INSTANCE_TYPE: "m4.xlarge"
      run: |
        cloudos job clone \
          --job-id "$JOB_ID" \
          --job-name "$JOB_NAME_BASE" \
          --instance-type "$INSTANCE_TYPE" \
          --workspace-id "$CLOUDOS_WORKSPACE_ID" \
          --project-name "$PROJECT_NAME" \
          --apikey "$CLOUDOS_TOKEN" \
          --cloudos-url "$CLOUDOS_URL"
  bash_array_job_run_and_multiple_projects:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      id: run-bash-array-job
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        WORKFLOW: "plink2"
        JOB_NAME_BASE: "cloudos_cli_CI_test_bash_array_job"
        COMMIT_HASH: ${{ github.event.pull_request.head.sha }}
        PR_NUMBER: ${{ github.event.number }}
      run: |
        cloudos bash array-job \
          --instance-type m4.xlarge \
          --memory 2 \
          --parameter -test=value \
          --parameter --gaq=test \
          --array-parameter --array_var=title \
          --job-name "$JOB_NAME_BASE" \
          --command "echo 'test' > new_file.txt" \
          --workspace-id "$CLOUDOS_WORKSPACE_ID" \
          --project-name "$PROJECT_NAME" \
          --workflow-name plink2 \
          --array-file Data/bash_array/sampleArray.csv \
          --separator "," \
          --apikey "$CLOUDOS_TOKEN" \
          --cloudos-url "$CLOUDOS_URL" \
          --parameter --file=ci-testing/Data/bash_array/input.csv \
          --wait-completion
  bash_array_clone:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      id: run-bash-job
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        JOB_NAME_BASE: "cloudos_cli_CI_test_bash_array_job_cloned"
        JOB_ID: "68d51f7b41b37cb06dea2a11"
        INSTANCE_TYPE: "m4.xlarge"
      run: |
        cloudos job clone \
          --job-id "$JOB_ID" \
          --job-name "$JOB_NAME_BASE" \
          --instance-type "$INSTANCE_TYPE" \
          --workspace-id "$CLOUDOS_WORKSPACE_ID" \
          --project-name "$PROJECT_NAME" \
          --apikey "$CLOUDOS_TOKEN" \
          --cloudos-url "$CLOUDOS_URL"
  dataset_copy_and_remove:
          runs-on: ubuntu-latest
          strategy:
            matrix:
              python-version: ["3.9"]
          steps:
          - uses: actions/checkout@v3
          - name: Set up Python ${{ matrix.python-version }}
            uses: actions/setup-python@v4
            with:
              python-version: ${{ matrix.python-version }}
              cache: pip
              cache-dependency-path: setup.py
          - name: Install dependencies
            run: |
              pip install -e .
          - name: Run tests
            env:
              CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
              CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
              PROJECT_NAME: "cloudos-cli-tests"
              CLOUDOS_URL: "https://cloudos.lifebit.ai"
            run: |
              cloudos datasets cp --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/mv_test/diffexpr-results.csv Data/test_copy
              cloudos datasets rm --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/test_copy/diffexpr-results.csv --force
  dataset_mkdir_and_remove:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        PROJECT_NAME: "cloudos-cli-tests"
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos datasets mkdir --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/rm_test
        cloudos datasets rm --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --project-name "$PROJECT_NAME" Data/rm_test
  archive_unarchive_job:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run tests
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        PROJECT_NAME: "cloudos-cli-tests"
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
      run: |
        cloudos job archive --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --job-ids 694545c801722f7aa3c626c4
        cloudos job unarchive --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --job-ids 694545c801722f7aa3c626c4
  configure_profile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Test configure profile workflow
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
      run: |
        # Step 1: Create a test profile by providing inputs via stdin
        echo "Creating profile 'ci-test-profile'..."
        echo -e "$CLOUDOS_TOKEN\n$CLOUDOS_URL\n$CLOUDOS_WORKSPACE_ID\n\n$PROJECT_NAME\n\n\n\n\n" | cloudos configure --profile ci-test-profile
        echo "Profile created successfully!"

        # Step 2: List all profiles to verify creation
        echo "Listing all profiles..."
        cloudos configure list-profiles | tee profiles_output.txt

        # Verify that our test profile exists in the list
        if grep -q "ci-test-profile" profiles_output.txt; then
          echo "✅ Profile 'ci-test-profile' found in the list"
        else
          echo "❌ Profile 'ci-test-profile' not found in the list"
          exit 1
        fi

        # Step 3: Remove the test profile
        echo "Removing profile 'ci-test-profile'..."
        cloudos configure remove-profile --profile ci-test-profile
        echo "Profile removed successfully!"

        # Step 4: List profiles again to verify removal
        echo "Listing profiles after removal..."
        cloudos configure list-profiles | tee profiles_after_removal.txt

        # Verify that our test profile no longer exists
        if grep -q "ci-test-profile" profiles_after_removal.txt; then
          echo "❌ Profile 'ci-test-profile' still exists after removal"
          exit 1
        else
          echo "✅ Profile 'ci-test-profile' successfully removed"
        fi

        echo "Configure profile workflow test completed successfully!"
  job_run_and_abort:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
        cache-dependency-path: setup.py
    - name: Install dependencies
      run: |
        pip install -e .
    - name: Run job, wait for running status, then abort
      env:
        CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
        CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
        CLOUDOS_URL: "https://cloudos.lifebit.ai"
        PROJECT_NAME: "cloudos-cli-tests"
        WORKFLOW: "GH-rnatoy"
        JOB_CONFIG: "cloudos_cli/examples/rnatoy.config"
        JOB_NAME_BASE: "cloudos-cli-CI-test-abort"
        COMMIT_HASH: ${{ github.event.pull_request.head.sha }}
        PR_NUMBER: ${{ github.event.number }}
        INSTANCE_TYPE: "m4.xlarge"
      run: |
        # Step 1: Run job (without --wait-completion so it doesn't wait until completion)
        JOB_NAME="$JOB_NAME_BASE""|GitHubCommit:""${COMMIT_HASH:0:6}""|PR-NUMBER:""$PR_NUMBER"
        cloudos job run --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --project-name "$PROJECT_NAME" --workflow-name "$WORKFLOW" --job-config $JOB_CONFIG --job-name "$JOB_NAME" --instance-type $INSTANCE_TYPE 2>&1 | tee out.txt
        JOB_ID=$(grep -e "Your assigned job id is:" out.txt | rev | cut -f1 -d " " | rev)
        echo "Job ID: $JOB_ID"

        # Step 2: Poll status until it reaches "running"
        MAX_ATTEMPTS=60
        SLEEP_TIME=10
        attempt=0

        while [ $attempt -lt $MAX_ATTEMPTS ]; do
          echo "Checking job status (attempt $((attempt+1))/$MAX_ATTEMPTS)..."
          STATUS=$(cloudos job status --cloudos-url $CLOUDOS_URL --workspace-id $CLOUDOS_WORKSPACE_ID --apikey $CLOUDOS_TOKEN --job-id $JOB_ID 2>&1 | grep -i "Your current job status is" | head -1 || echo "unknown")
          echo "Current status: $STATUS"

          if echo "$STATUS" | grep -qi "running"; then
            echo "Job is now running!"
            break
          elif echo "$STATUS" | grep -qi "completed\|failed\|aborted"; then
            echo "Job finished before we could abort it (status: $STATUS)"
            exit 0
          fi

          attempt=$((attempt+1))
          sleep $SLEEP_TIME
        done

        if [ $attempt -eq $MAX_ATTEMPTS ]; then
          echo "Job did not reach running status within timeout"
          exit 1
        fi

        # Step 3: Abort the running job
        echo "Aborting job $JOB_ID..."
        cloudos job abort --cloudos-url "$CLOUDOS_URL" --apikey "$CLOUDOS_TOKEN" --workspace-id "$CLOUDOS_WORKSPACE_ID" --job-ids $JOB_ID
        echo "Job abort command executed successfully!"
  delete_workdir:
    needs: job_run_and_status
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.9" ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: setup.py
      - name: Install dependencies
        run: |
          pip install -e .
      - name: Run tests
        env:
          CLOUDOS_TOKEN: ${{ secrets.CLOUDOS_TOKEN }}
          CLOUDOS_WORKSPACE_ID: ${{ secrets.CLOUDOS_WORKSPACE_ID }}
          CLOUDOS_URL: "https://cloudos.lifebit.ai"
        run: |
          cloudos job workdir --delete --yes --cloudos-url $CLOUDOS_URL --apikey $CLOUDOS_TOKEN --workspace-id $CLOUDOS_WORKSPACE_ID --job-id ${{ needs.job_run_and_status.outputs.job_id }}
